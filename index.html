<!DOCTYPE html>
<html>
<head>
  <title>iCode WG Tool V1.0</title>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #f4f4f4; 
      margin: 0;
      padding: 20px; 
      box-sizing: border-box; 
    }

    h1 {
      color: #333; 
      text-align: center;
    }

    #qr-input {
      margin: 20px;
      padding: 10px;
      border: 1px solid #ddd; 
      border-radius: 5px; 
      width: 100%; 
      max-width: 400px;
      box-sizing: border-box;
    }

    #decode-btn, #create-conf-btn {
      background-color: #007bff; 
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 5px; 
      cursor: pointer;
      transition: background-color 0.3s ease; 
      width: 100%; 
      max-width: 300px;
      box-sizing: border-box;
    }

    #decode-btn:hover, #create-conf-btn:hover {
      background-color: #0056b3; 
    }

    #create-conf-btn {
      margin-top: 10px; 
    }

    #decoded-text {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd; 
      min-height: 50px;
      word-break: break-all;
      white-space: pre-wrap; 
      font-family: monospace; 
      text-align: left; 
      background-color: #fff; 
      border-radius: 5px; 
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
      width: 100%;
      max-width: 800px; 
      box-sizing: border-box;
      overflow-x: auto;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <h1>iCode WG Tool V1.0</h1> 

  <input type="file" id="qr-input" accept="image/*" />
  <button id="decode-btn">Decode from Image</button>

  <h2>Decoded Text:</h2>
  <div id="decoded-text"></div>

  <button id="create-conf-btn" disabled>Create conf</button> 
  <div id="download-link"></div> 

  <script>
    const qrInput = document.getElementById('qr-input');
    const decodeBtn = document.getElementById('decode-btn');
    const createConfBtn = document.getElementById('create-conf-btn');
    const decodedTextDiv = document.getElementById('decoded-text');
    const downloadLinkDiv = document.getElementById('download-link');

    decodeBtn.addEventListener('click', () => {
      if (qrInput.files.length > 0) {
        const qrCodeData = qrInput.files[0];

        const formData = new FormData();
        formData.append('file', qrCodeData);

        fetch('https://api.qrserver.com/v1/read-qr-code/', { 
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data && data[0] && data[0].symbol && data[0].symbol[0] && data[0].symbol[0].data) {
            const decodedText = data[0].symbol[0].data;

            createConfBtn.disabled = false; 

            const formattedText = formatWireguardConfig(decodedText); 
            decodedTextDiv.textContent = formattedText;
          } else {
            decodedTextDiv.textContent = "QR code not found in image.";
          }
        })
        .catch(error => {
          console.error('Error decoding QR code:', error);
          decodedTextDiv.textContent = "Error decoding QR code.";
        });
      } else {
        alert("Please select a QR code image first.");
      }
    });

    createConfBtn.addEventListener('click', () => {
      const textContent = decodedTextDiv.textContent;
      const filename = "wg0.conf"; 

      const blob = new Blob([textContent], { type: "application/x-config" }); 
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = filename;

      downloadLinkDiv.innerHTML = ""; 
      downloadLinkDiv.appendChild(link); 
      link.click(); 

      URL.revokeObjectURL(url); 
    });

    function formatWireguardConfig(config) {
      const lines = config.split('\n');
      let formattedConfig = "";

      const interfaceRegex = /^(Address|DNS|PrivateKey)\s*=\s*(.*)$/;
      const peerRegex = /^(PublicKey|PresharedKey|AllowedIPs|Endpoint|PersistentKeepalive)\s*=\s*(.*)$/;

      let currentSection = "";

      for (const line of lines) {
        let match;

        if (line.startsWith("[Interface]")) {
          currentSection = "Interface";
          formattedConfig += line + "\n";
        } else if (line.startsWith("[Peer]")) {
          currentSection = "Peer";
          formattedConfig += line + "\n";
        } else if (currentSection === "Interface" && (match = line.match(interfaceRegex))) {
          formattedConfig += `${match[1]} = ${match[2]}\n`;
        } else if (currentSection === "Peer" && (match = line.match(peerRegex))) {
          formattedConfig += `${match[1]} = ${match[2]}\n`;
        }
      }

      return formattedConfig;
    }
  </script>
</body>
</html>
